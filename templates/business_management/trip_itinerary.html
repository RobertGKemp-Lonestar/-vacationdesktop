{% extends "base.html" %}
{% load static %}

{% block title %}{{ trip.trip_name }} Itinerary - Travel Advisor CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">{{ trip.trip_name }} - Itinerary</h1>
                    <p class="text-muted">{{ trip.destination }} • {{ trip.departure_date|date:"M d, Y" }} - {{ trip.return_date|date:"M d, Y" }}</p>
                </div>
                <div>
                    <a href="{% url 'trip_detail' trip.id %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Back to Trip
                    </a>
                    <button class="btn btn-success me-2" onclick="emailItinerary()">
                        <i class="bi bi-envelope"></i> Email to Client
                    </button>
                    <button class="btn btn-primary" onclick="addItineraryDay()">
                        <i class="bi bi-plus-circle"></i> Add Day
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trip Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h5 class="text-primary mb-0">{{ trip.get_trip_type_display }}</h5>
                            <small class="text-muted">Trip Type</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-success mb-0">{{ itinerary_days.count }} Day{{ itinerary_days.count|pluralize }}</h5>
                            <small class="text-muted">Planned</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-info mb-0">{{ trip.number_of_travelers|default:1 }}</h5>
                            <small class="text-muted">Traveler{{ trip.number_of_travelers|pluralize }}</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-warning mb-0">{{ trip.get_status_display }}</h5>
                            <small class="text-muted">Status</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Itinerary Builder -->
    <div class="row">
        <div class="col-12">
            {% if itinerary_days %}
                <!-- Existing Itinerary Days -->
                <div id="itinerary-container">
                    {% for day in itinerary_days %}
                        <div class="card border-0 shadow-sm mb-3" id="day-{{ day.id }}" data-day-id="{{ day.id }}">
                            <div class="card-header bg-white border-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-primary me-3 fs-6">Day {{ day.day_number }}</span>
                                        <h6 class="mb-0">{{ day.title|default:"Day Activities" }}</h6>
                                        {% if day.date %}
                                            <small class="text-muted ms-3">{{ day.date|date:"M d, Y" }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="editDay('{{ day.id }}', '{{ day.title|escapejs }}', '{{ day.description|escapejs }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="insertDayAfter({{ day.day_number }})">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteDay('{{ day.id }}', {{ day.day_number }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        {% if day.description %}
                                            <div class="itinerary-description">
                                                {{ day.description|linebreaks }}
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No description added yet. <a href="#" onclick="editDay('{{ day.id }}', '{{ day.title|escapejs }}', '')">Add description</a></p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <!-- Quick activity icons -->
                                        <div class="activity-tags">
                                            {% if 'flight' in day.description|lower or 'plane' in day.description|lower %}
                                                <span class="badge bg-info me-1"><i class="bi bi-airplane"></i> Flight</span>
                                            {% endif %}
                                            {% if 'hotel' in day.description|lower or 'accommodation' in day.description|lower %}
                                                <span class="badge bg-success me-1"><i class="bi bi-house"></i> Hotel</span>
                                            {% endif %}
                                            {% if 'tour' in day.description|lower %}
                                                <span class="badge bg-warning me-1"><i class="bi bi-camera"></i> Tour</span>
                                            {% endif %}
                                            {% if 'meal' in day.description|lower or 'dinner' in day.description|lower or 'lunch' in day.description|lower %}
                                                <span class="badge bg-danger me-1"><i class="bi bi-cup-hot"></i> Dining</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Time-based activities (future enhancement) -->
                                <div class="mt-3" style="display: none;" id="activities-{{ day.id }}">
                                    <h6 class="text-muted">Scheduled Activities</h6>
                                    <div class="timeline-activities">
                                        <!-- Future: Add time-specific activities -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- No Itinerary Yet -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-calendar-check display-1 text-muted"></i>
                        <h4 class="mt-3">No Itinerary Created Yet</h4>
                        <p class="text-muted">Start building the day-by-day itinerary for this trip.</p>
                        <button class="btn btn-primary btn-lg" onclick="addItineraryDay()">
                            <i class="bi bi-plus-circle"></i> Create First Day
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit Day Modal -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Itinerary Day</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dayForm">
                    {% csrf_token %}
                    <input type="hidden" id="action" name="action" value="add_day">
                    <input type="hidden" id="dayId" name="day_id">
                    <input type="hidden" id="dayNumber" name="day_number">
                    
                    <div class="mb-3">
                        <label for="dayTitle" class="form-label">Day Title</label>
                        <input type="text" class="form-control" id="dayTitle" name="title" 
                               placeholder="e.g., Arrival & City Tour">
                        <div class="form-text">Give this day a memorable title</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dayDescription" class="form-label">Description & Activities</label>
                        <textarea class="form-control" id="dayDescription" name="description" rows="6" 
                                  placeholder="Describe the day's activities, schedule, and notes...

Example:
Morning: Arrival at airport, transfer to hotel
10:00 AM - Check in at Grand Hotel (123 Main St)
2:00 PM - Walking tour of historic district
6:00 PM - Welcome dinner at La Bella Vista
Evening: Free time to explore"></textarea>
                        <div class="form-text">Be detailed - this will be shared with your client</div>
                    </div>
                    
                    <!-- Quick activity buttons -->
                    <div class="mb-3">
                        <label class="form-label">Quick Add</label>
                        <div class="btn-group-sm d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-info" onclick="addQuickActivity('Flight')">
                                <i class="bi bi-airplane"></i> Flight
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="addQuickActivity('Hotel Check-in')">
                                <i class="bi bi-house"></i> Hotel
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="addQuickActivity('Guided Tour')">
                                <i class="bi bi-camera"></i> Tour
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="addQuickActivity('Meal')">
                                <i class="bi bi-cup-hot"></i> Dining
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="addQuickActivity('Transportation')">
                                <i class="bi bi-car-front"></i> Transport
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addQuickActivity('Free Time')">
                                <i class="bi bi-clock"></i> Free Time
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDay()">Save Day</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Itinerary Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Itinerary to Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Send the complete itinerary to <strong>{{ trip.client.full_name }}</strong> ({{ trip.client.email }})?</p>
                
                <div class="mb-3">
                    <label for="customMessage" class="form-label">Personal Message (Optional)</label>
                    <textarea class="form-control" id="customMessage" rows="3" 
                              placeholder="Add a personal message to include with the itinerary..."></textarea>
                    <div class="form-text">This message will appear at the top of the itinerary email</div>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includePDF" checked>
                    <label class="form-check-label" for="includePDF">
                        Include PDF attachment (Coming Soon)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendItineraryEmail()">Send Email</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

<script>
let currentDayNumber = null;
let currentDayId = null;
let dayModal = null;
let emailModal = null;

// Initialize modals after DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    dayModal = new bootstrap.Modal(document.getElementById('dayModal'));
    emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
});

function addItineraryDay() {
    if (!dayModal) {
        dayModal = new bootstrap.Modal(document.getElementById('dayModal'));
    }
    
    const nextDayNumber = document.querySelectorAll('[id^="day-"]').length + 1;
    currentDayNumber = nextDayNumber;
    currentDayId = null;
    
    document.getElementById('modalTitle').textContent = `Add Day ${nextDayNumber}`;
    document.getElementById('action').value = 'add_day';
    document.getElementById('dayId').value = '';
    document.getElementById('dayNumber').value = nextDayNumber;
    document.getElementById('dayTitle').value = '';
    document.getElementById('dayDescription').value = '';
    
    dayModal.show();
}

function insertDayAfter(dayNumber) {
    if (!dayModal) {
        dayModal = new bootstrap.Modal(document.getElementById('dayModal'));
    }
    
    const nextDayNumber = dayNumber + 1;
    currentDayNumber = nextDayNumber;
    currentDayId = null;
    
    document.getElementById('modalTitle').textContent = `Insert Day ${nextDayNumber}`;
    document.getElementById('action').value = 'add_day';
    document.getElementById('dayId').value = '';
    document.getElementById('dayNumber').value = nextDayNumber;
    document.getElementById('dayTitle').value = '';
    document.getElementById('dayDescription').value = '';
    
    dayModal.show();
}

function editDay(dayId, title, description) {
    if (!dayModal) {
        dayModal = new bootstrap.Modal(document.getElementById('dayModal'));
    }
    
    currentDayId = dayId;
    
    document.getElementById('modalTitle').textContent = 'Edit Day';
    document.getElementById('action').value = 'edit_day';
    document.getElementById('dayId').value = dayId;
    document.getElementById('dayTitle').value = title;
    document.getElementById('dayDescription').value = description;
    
    dayModal.show();
}

function deleteDay(dayId, dayNumber) {
    if (confirm(`Are you sure you want to delete Day ${dayNumber}? This action cannot be undone.`)) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('action', 'delete_day');
        formData.append('day_id', dayId);
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated day numbers
            } else {
                alert(data.message || 'Failed to delete day');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the day');
        });
    }
}

function saveDay() {
    const formData = new FormData(document.getElementById('dayForm'));
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            dayModal.hide();
            location.reload(); // Refresh to show new/updated day
        } else {
            alert(data.message || 'Failed to save day');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the day');
    });
}

function addQuickActivity(activity) {
    const textarea = document.getElementById('dayDescription');
    const currentText = textarea.value;
    let newActivity = '';
    
    switch(activity) {
        case 'Flight':
            newActivity = '\n• Flight: [Time] - [Airline] [Flight #] ([Departure] → [Arrival])';
            break;
        case 'Hotel Check-in':
            newActivity = '\n• Hotel Check-in: [Hotel Name] ([Address])';
            break;
        case 'Guided Tour':
            newActivity = '\n• [Time] - Guided tour of [Location/Activity]';
            break;
        case 'Meal':
            newActivity = '\n• [Time] - [Meal type] at [Restaurant Name]';
            break;
        case 'Transportation':
            newActivity = '\n• [Time] - Transfer from [Location A] to [Location B]';
            break;
        case 'Free Time':
            newActivity = '\n• [Time] - Free time to explore [Area/Activity]';
            break;
    }
    
    textarea.value = currentText + newActivity;
    textarea.focus();
}

function emailItinerary() {
    if (!emailModal) {
        emailModal = new bootstrap.Modal(document.getElementById('emailModal'));
    }
    emailModal.show();
}

function sendItineraryEmail() {
    const sendButton = document.querySelector('#emailModal .btn-primary');
    const originalText = sendButton.textContent;
    const customMessage = document.getElementById('customMessage').value;
    const includePDF = document.getElementById('includePDF').checked;
    
    // Show loading state
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Sending...';
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('action', 'email_itinerary');
    formData.append('custom_message', customMessage);
    formData.append('include_pdf', includePDF ? 'on' : 'off');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            emailModal.hide();
            // Clear the message field for next use
            document.getElementById('customMessage').value = '';
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        } else {
            alert(data.message || 'Failed to send itinerary');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the itinerary');
    })
    .finally(() => {
        // Reset button state
        sendButton.disabled = false;
        sendButton.textContent = originalText;
    });
}

// Initialize sortable functionality (future enhancement)
// Can add drag-and-drop reordering of days here
</script>

<style>
.activity-tags .badge {
    font-size: 0.75em;
}

.itinerary-description {
    white-space: pre-line;
    line-height: 1.6;
}

.timeline-activities {
    border-left: 2px solid #e9ecef;
    padding-left: 1rem;
    margin-left: 0.5rem;
}

#itinerary-container .card {
    transition: all 0.3s ease;
}

#itinerary-container .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}
</style>
{% endblock %}